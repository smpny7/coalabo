---
title: "草bot (wbot) の開発談"
description: "Discord用 Bot です。大人数サーバーで何かしら返事をくれます。"
date: 2021-04-25T00:00:00+09:00
slug: wbot
image: cover.jpg
categories:
    - Node.js
    - JavaScript
tags:
    - Bot作成
    - ネタ回
---

## 察してください、ネタ回です

Molly fantasy って実在したんですね。

今回は、友人十数名が入ったDiscordサーバーがあるのですが、
そのサーバー用の Bot を作った、という箸休め回です。

この Bot は、みんなが登録したキーワードを打つと対応した語録を発言してくれます。


## なんか盛り上がって、つくることになった

草Botくん、「草」という文字が入っていると、「草」と返してくれることからこの名前がついたんです。

![草Botくん](image_1.jpg)

実はこの草Bot、今はおもちゃにされています。

もはやBotの表示名も変えられてますw

## 敗因: 誰でもプルリクOK＆自動デプロイ仕様にしてしまった

最初は「草」と返してくれる Bot だったのですが、サーバーメンバーがこの Bot にどんどん単語を登録していきました。
ただ、そのセンスがかなり良すぎるので、本来の目的が語録に変わって私も大満足です(笑)

せっかくなので、自分のお気に入り語録を紹介しましょう。

---

これ何だかわかりますか？

![お気に入り語録 その1](image_2.jpg)

↑ これをみてピンときた人はさすがですね ！

---

![実はこれ](image_3.jpg)

これですね！いつものやつです。

実は以前、みんなで Raspberry Pi OS をセットアップしてた時ですが、
日本語化がうまくいかず、文字化けで何も見えない現象が発生してしまいました。

唯一文字化けしていても意味がわかった文面が上の文字列で、

> 伏字にしているのに、隠せれてないwwww

という経緯で追加されました(笑)

---

もう一つのお気に入りはこれです。

![「腹痛」に反応します](image_4.jpg)

「腹痛」という単語を聞くと、よくわからない係数を測ってくれ、それに応じてアナウンスが流れます。

> 元ネタはこちら [ニコニコ大百科（ドミネーター）](https://dic.nicovideo.jp/a/%E3%83%89%E3%83%9F%E3%83%8D%E3%83%BC%E3%82%BF%E3%83%BC%28psycho-pass%29)

しかもこれは、例のよくわからない係数（乱数）に応じてメッセージが変わります。


## 今回の技術的なコト

Node.js で作りましたが、Bot はすぐできるので記事にするほどでもないかと思います。

詳しくは以下のドキュメントをどうぞ！

> **Discord.js** [https://discord.js.org](https://discord.js.org)

今回、この Bot は [Heroku](https://jp.heroku.com/home)にデプロイしているので、こちらの知見を共有したいと思います。

Herokuでは、GitHubリポジトリとHerokuAppを連携させることができます。連携しておくと、
GitHubのmainブランチにプッシュされた時に Webhook が飛ばされ Heroku に自動でデプロイされるのでとても便利です。

ただ今回、気をつける点が2つありました。

- Procfile を作成すること
- プロセスタイプを worker に設定すること

この2つを共有して、本記事の締めにしたいと思います。


## Procfile を作成すること

Procfile とは、デプロイ時にどのようなコマンドで run（開始）するかを記述したものです。

**Procfile | Heroku Dev Center** には以下のような記述があります。

> Herokuによりサポートされているほとんどの言語で書かれたアプリをデプロイするのに、Procfileは必要はありません。

> プラットフォームが使われている言語を自動的に検知し、アプリケーションサーバーを起動するために、デフォルトのwebプロセスタイプを作成してくれます。

しかし自動的に検知してくれなかったのか、私の環境では実行されなかったので `Procfile` を作成しました。

書き方は以下の通りです。

```shell
(processType) : (command)
```

今回の場合、以下の記述が必要です。

```shell
worker: node index.js
```

`Procfile` はアプリのルートディレクトリに設置する必要があります。


## dyno を worker に設定すること

もう1つ、今回 Heroku 独特のプロセス処理の種類である `dyno` をデフォルトから変更する必要がありました。

dyno には `web` , `worker` , `one-off` の3種類があります。

|  種類      |  機能                                                                                               |
| ----      | ----                                                                                               |
|  Web      |  ルーターから HTTP トラフィックを受信し、通常は Web サーバーを実行します。                                     |
|  Worker   |  バックグラウンドジョブ、キューイングシステム、時間指定のあるジョブなどを実行します。                              |
|  One-off  |  管理タスクの処理（REPL シェルを実行してデータベースの移行や一時的なバックグラウンド作業を行う場合など）に使用します。  |

今回、Discord Bot では常にチャンネルのテキストを取得する必要があるため、`worker` に設定する必要があります。

HerokuCLI を導入している場合は、以下のコマンドで `worker` に切り替えることができます。

```shell
heroku ps:scale worker=1
```


## さいごに

なんだかんだ、やっぱりBotがいてくれると楽しいですよね。

次はもっと有用な Bot を作りたいと思います (笑)
